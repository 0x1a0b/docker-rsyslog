  1: # rsyslog configuration file
  2: 
  3: ## Global Directives and defaults
  4: 
  5: # Where to place auxiliary files
  6: $WorkDirectory /var/lib/rsyslog
  7: 
  8: # Use default timestamp format (can be overidden per rule set)
  9: $ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat
 10: 
 11: # Include config files in /etc/rsyslog.d/
 12: $IncludeConfig /etc/rsyslog.d/*.conf
##< start of include directive: $IncludeConfig /etc/rsyslog.d/*.conf
##^ expanding file: /etc/rsyslog.d/30-globals.conf
  1: # Collect stats - rsyslog docs warn to load this module first before others (but might only be applicable to legacy config)
  2: module(
  3:   load="impstats"
  4:   interval="60"
  5:   resetCounters="on"
  6:   Format="cee"
  7:   ruleset="syslog_stats"
  8: )
  9: 
 10: # Load extra parser modules which the peoples might want to use in the parser chain - will waste a bit of memory, but keeps logic simpler
 11: module(load="pmlastmsg")
 12: module(load="pmaixforwardedfrom")
 13: module(load="pmciscoios")
 14: module(load="pmnull")
 15: 
 16: module(load="mmjsonparse")
 17: # Parse RFCR424 structured data
 18: module(load="mmpstrucdata")
 19: 
 20: # Globals
 21: global(
 22:   parser.permitSlashInProgramName="on"
 23:   parser.escapeControlCharacterTab="off"
 24:   preserveFQDN="on"
 25:   maxMessageSize="65536"
 26:   action.reportSuspension="on"
 27:   senders.keepTrack="on"
 28:   senders.timeoutAfter="86400"
 29:   senders.reportGoneAway="on"
 30:   shutdown.enable.ctlc="on"
 31:   processInternalMessages="on"
 32: )
##^ expanding file: /etc/rsyslog.d/50-output_format.conf
  1: # Output templates
  2: # Built-in templates at https://www.rsyslog.com/doc/v8-stable/configuration/templates.html#reserved-template-names
  3: # E.g.
  4: # - RSYSLOG_TraditionalFileFormat
  5: # - RSYSLOG_FileFormat
  6: # - RSYSLOG_TraditionalForwardFormat
  7: # - RSYSLOG_SyslogProtocol23Format
  8: 
  9: # Simple raw message template (might be useful for passing on messages unprocessed)
 10: template(name="RawMsg" type="string" string="%rawmsg%\n")
 11: 
 12: # Misc templates (e.g. for calling via exec_template)
 13: # TODO: If need be
 14: 
 15: # Standard example of RFC5424
 16: # Note, RSYSLOG_SyslogProtocol23Format is the built-in reserved template name for a draft of RFC5424, so the above is more or less identical to that
 17: template(name="TmplRFC5424" type="string" string="<%pri%>1 %timestamp:::date-rfc3339% %hostname% %app-name% %procid% %msgid% %structured-data% %msg%\n")
 18: 
 19: # RFC5424 with syslog relay and own custom meta-data pre-pended to the structured data element
 20: # Like RSYSLOG_SyslogProtocol23Format, but with a special extra structured data field to append structured data.
 21: # Use of variable property types as per https://www.rsyslog.com/doc/master/rainerscript/variable_property_types.html
 22: # Regex needed to deal with structured data being null '-' and needing to append/replace null.
 23: # `%structured-data:R,ERE,0,BLANK:[[].*--end%` avoids appending a null charceter '-' if there wasn't any pre-existing structured data.
 24: # See http://www.rsyslog.com/doc/v8-stable/configuration/nomatch.html
 25: template(name="TmplRFC5424Meta" type="string" string="<%pri%>1 %timestamp:::date-rfc3339% %$.hostname% %app-name% %procid% %msgid% [syslog-relay@16543 timegenerated=\"%timegenerated:::date-rfc3339%\" fromhost=\"%fromhost%\" fromhost-ip=\"%fromhost-ip%\" myhostname=\"%$myhostname%\" inputname=\"%inputname%\" format=\"%$.syslog-relay!format%\" pri-valid=\"%$.syslog-relay!pri-valid%\" header-valid=\"%$.syslog-relay!header-valid%\" json-msg-parsed=\"%$.syslog-relay!json-msg-parsed%\" tls=\"%$.syslog-relay!tls%\" authenticated-client=\"%$.syslog-relay!authenticated-client%\"]%structured-data:R,ERE,0,BLANK:[[].*--end% %msg%\n")
 26: 
 27: # JSON templates
 28: 
 29: # Make sure the message content is escaped to be safely interpreted as JSON
 30: # Note:
 31: # - NB! Rainerscript only supports setting quoted variables and jsonf outputs a quoted value forcing a string JSON type.
 32: # - To get integer or boolean JSON types requires manually building a JSON field, i.e. otherwise { "boolean": true } gets quoted as { "boolean": "true" }
 33: # - The template jsonf datatype option can be used in templates to coerce types upon output, but rainerscript config still treats/reads everything like strings.
 34: # - The 'bool' datatype does not treat string "false" as a literal false and only interprets "0" or the empty string "" as false.
 35: # - Therefore it's not adaptable to use for non-JSON output that needs a literal string 'false'.
 36: # - See https://github.com/rsyslog/rsyslog/issues/3836
 37: # - See https://www.rsyslog.com/doc/v8-stable/configuration/templates.html#property-statement
 38: # Due to this, and some values being used in both JSON and plaintext output template choices, manually crafted templates instead of using a jsonf datatype is performed.
 39: # While bool and int JSON types are used, for RFC5424, `-` represents null and is left as when the field is flat (not a nested object). 
 40: # Structured data element handling is complex and involves 2 different fields
 41: # - 'structured-data' will be the string representation (not parsed to JSON) and null represented as string character `-`.
 42: # - 'rfc5424-sd' will be the JSON parsed nested object (if rsyslog_mmpstrucdata is enabled) and null represented as literal string `"null"`
 43: # - If the structured data element is `-` it's 'structured-data' property is left as a string `-` else 
 44: # - Downstream systems like elasticsearch will have data mapping conflicts if it expects a json object (e.g. nested field) but instead gets a plain string (e.g. `"null"`). Logstash can coerce/remove the "null" field when present to avoid the issue.
 45: 
 46: # Output the full native rsyslog JSON message object
 47: template(name="TmplRSyslogJSON" type="string" string="%jsonmesg%\n")
 48: 
 49: # Output a subset of the native rsyslog JSON message fields
 50: # Note:
 51: # - JSON $! tree output will output empty enclosing brakets { } if $! doesn't have any JSON values set which will cause invalid JSON, so strip these by removing first 2 charceters '{ ' and allowing the end closing braket to occur in case this is indeed empty.
 52: # - Handle cases where metadata or structured data is to be added
 53: # - if metadata is enabled, RFC3164 assumed hostname parsing that might be incorrect are replaced with local var $.hostname = $fromhost instead of standard $hostname property when headers are detected as non-conformant
 54: template(name="TmplJSON" type="list") {
 55:   constant(value="{ ")
 56:   property(name="syslogfacility" format="jsonf")
 57:   constant(value=", ")
 58:   property(name="syslogfacility-text" format="jsonf")
 59:   constant(value=", ")
 60:   property(name="syslogseverity" format="jsonf")
 61:   constant(value=", ")
 62:   property(name="syslogseverity-text" format="jsonf")
 63:   constant(value=", ")
 64:   property(name="timestamp" dateFormat="rfc3339" format="jsonf")
 65:   constant(value=", ")
 66:   property(name="$.hostname" outname="hostname" format="jsonf")
 67:   constant(value=", ")
 68:   property(name="app-name" format="jsonf")
 69:   constant(value=", ")
 70:   property(name="procid" format="jsonf")
 71:   constant(value=", ")
 72:   property(name="msgid" format="jsonf")
 73:   constant(value=", ")
 74:   constant(value="\"syslog-relay\": { ")
 75:   property(name="timegenerated" dateFormat="rfc3339" format="jsonf")
 76:   constant(value=", ")
 77:   property(name="fromhost" format="jsonf")
 78:   constant(value=", ")
 79:   property(name="fromhost-ip" format="jsonf")
 80:   constant(value=", \"myhostname\":\"")
 81:   property(name="$myhostname" format="jsonr")
 82:   constant(value="\", ")
 83:   property(name="inputname" format="jsonf")
 84:   constant(value=", \"format\":\"")
 85:   property(name="$.syslog-relay!format" format="jsonr")
 86:   constant(value="\", \"pri-valid\":")
 87:   property(name="$.syslog-relay!pri-valid")
 88:   constant(value=", \"header-valid\":")
 89:   property(name="$.syslog-relay!header-valid")
 90:   constant(value=", \"json-msg-parsed\":")
 91:   property(name="$.syslog-relay!json-msg-parsed")
 92:   constant(value=", \"tls\":")
 93:   property(name="$.syslog-relay!tls")
 94:   constant(value=", \"authenticated-client\":")
 95:   property(name="$.syslog-relay!authenticated-client")
 96:   constant(value=" }, ")
 97:   
 98:   property(name="msg" format="jsonf")
 99:   constant(value=", ")
100:   property(name="$!" position.from="2")
101:   constant(value="\n")
102: }
103: 
104: template(name="TmplJSONRawMsg" type="list") {
105:   constant(value="{ ")
106:   property(name="syslogfacility" format="jsonf")
107:   constant(value=", ")
108:   property(name="syslogfacility-text" format="jsonf")
109:   constant(value=", ")
110:   property(name="syslogseverity" format="jsonf")
111:   constant(value=", ")
112:   property(name="syslogseverity-text" format="jsonf")
113:   constant(value=", ")
114:   property(name="timestamp" dateFormat="rfc3339" format="jsonf")
115:   constant(value=", ")
116:   property(name="$.hostname" outname="hostname" format="jsonf")
117:   constant(value=", ")
118:   property(name="app-name" format="jsonf")
119:   constant(value=", ")
120:   property(name="procid" format="jsonf")
121:   constant(value=", ")
122:   property(name="msgid" format="jsonf")
123:   constant(value=", ")
124:   constant(value="\"syslog-relay\": { ")
125:   property(name="timegenerated" dateFormat="rfc3339" format="jsonf")
126:   constant(value=", ")
127:   property(name="fromhost" format="jsonf")
128:   constant(value=", ")
129:   property(name="fromhost-ip" format="jsonf")
130:   constant(value=", \"myhostname\":\"")
131:   property(name="$myhostname" format="jsonr")
132:   constant(value="\", ")
133:   property(name="inputname" format="jsonf")
134:   constant(value=", \"format\":\"")
135:   property(name="$.syslog-relay!format" format="jsonr")
136:   constant(value="\", \"pri-valid\":")
137:   property(name="$.syslog-relay!pri-valid")
138:   constant(value=", \"header-valid\":")
139:   property(name="$.syslog-relay!header-valid")
140:   constant(value=", \"json-msg-parsed\":")
141:   property(name="$.syslog-relay!json-msg-parsed")
142:   constant(value=", \"tls\":")
143:   property(name="$.syslog-relay!tls")
144:   constant(value=", \"authenticated-client\":")
145:   property(name="$.syslog-relay!authenticated-client")
146:   constant(value=" }, ")
147:   
148:   property(name="rawmsg" format="jsonf")
149:   constant(value=", ")
150:   property(name="$!" position.from="2")
151:   constant(value="\n")
152: }
153: 
154: template(name="TmplJSONMsgAndRawMsg" type="list") {
155:   constant(value="{ ")
156:   property(name="syslogfacility" format="jsonf")
157:   constant(value=", ")
158:   property(name="syslogfacility-text" format="jsonf")
159:   constant(value=", ")
160:   property(name="syslogseverity" format="jsonf")
161:   constant(value=", ")
162:   property(name="syslogseverity-text" format="jsonf")
163:   constant(value=", ")
164:   property(name="timestamp" dateFormat="rfc3339" format="jsonf")
165:   constant(value=", ")
166:   property(name="$.hostname" outname="hostname" format="jsonf")
167:   constant(value=", ")
168:   property(name="app-name" format="jsonf")
169:   constant(value=", ")
170:   property(name="procid" format="jsonf")
171:   constant(value=", ")
172:   property(name="msgid" format="jsonf")
173:   constant(value=", ")
174:   constant(value="\"syslog-relay\": { ")
175:   property(name="timegenerated" dateFormat="rfc3339" format="jsonf")
176:   constant(value=", ")
177:   property(name="fromhost" format="jsonf")
178:   constant(value=", ")
179:   property(name="fromhost-ip" format="jsonf")
180:   constant(value=", \"myhostname\":\"")
181:   property(name="$myhostname" format="jsonr")
182:   constant(value="\", ")
183:   property(name="inputname" format="jsonf")
184:   constant(value=", \"format\":\"")
185:   property(name="$.syslog-relay!format" format="jsonr")
186:   constant(value="\", \"pri-valid\":")
187:   property(name="$.syslog-relay!pri-valid")
188:   constant(value=", \"header-valid\":")
189:   property(name="$.syslog-relay!header-valid")
190:   constant(value=", \"json-msg-parsed\":")
191:   property(name="$.syslog-relay!json-msg-parsed")
192:   constant(value=", \"tls\":")
193:   property(name="$.syslog-relay!tls")
194:   constant(value=", \"authenticated-client\":")
195:   property(name="$.syslog-relay!authenticated-client")
196:   constant(value=" }, ")
197:   
198:   property(name="msg" format="jsonf")
199:   constant(value=", ")
200:   property(name="rawmsg" format="jsonf")
201:   constant(value=", ")
202:   property(name="$!" position.from="2")
203:   constant(value="\n")
204: }
205: 
206: # Special templates for handling rsyslog errors
207: template(name="DynStatsError" type="string" string="fromhost=%fromhost% error=%$.inc_status%\n")
208: template(name="Empty" type="string" string="")
##^ expanding file: /etc/rsyslog.d/60-ruleset.conf
  1: # Rules and actions to apply when a specific kind of input is received
  2: # Note extensive use of variable property types as per https://www.rsyslog.com/doc/master/rainerscript/variable_property_types.html
  3: 
  4: # Customise the settings of the built-in RFC3164 to use extra options to better handle malformed messages
  5: # - Avoid populating syslog tags incorrectly when bad clients don't follow tagging conventions
  6: # - Avoid adding in a pre-pending space in the message field
  7: parser(
  8:   name="custom.rfc3164" type="pmrfc3164"
  9:   force.tagEndingByColon="on"
 10:   remove.msgFirstSpace="on"
 11:   permit.squareBracketsInHostname="off"
 12:   permit.slashesInHostname="on"
 13:   permit.atSignsInHostname="off"
 14: )
 15: 
 16: # Stats
 17: ruleset(name="syslog_stats") {
 18:   # TODO
 19:   # - In future ommit setting these values and simply ommit from message when not relevant
 20:   # - Needed for now due to explicit templating because of issues like https://github.com/rsyslog/rsyslog/issues/2873
 21:   set $.syslog-relay!tls = "false";
 22:   set $.syslog-relay!authenticated-client = "false";
 23:   call central
 24: }
 25: 
 26: # To count message input per source
 27: # Note about reliablity of hostname and fromhost rsyslog properties
 28: # - Can't always trust hostname 
 29: #   - source can send malformed syslog headers
 30: #   - $.hostname is sometimes used to correct for cases where something seems incorrect about the source hostname
 31: #   - $fromhost might be a more reliable metric than $hostname for the above situation
 32: # - Can't always trust fromhost
 33: #   - SNAT might cause fromhost to have the IP of a network device and not the actual host sending the message
 34: # So both hostname nor fromhost can have corner cases that make accounting for the true source inaccurate
 35: # Filtering can affect the per message host count, e.g. more inputs than outputs
 36: dyn_stats(name="msg_per_fromhost_remote_in_udp_pre_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
 37: dyn_stats(name="msg_per_fromhost_remote_in_tcp_pre_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
 38: dyn_stats(name="msg_per_fromhost_remote_in_tcp_secure_pre_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
 39: dyn_stats(name="msg_per_fromhost_remote_in_relp_pre_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
 40: dyn_stats(name="msg_per_fromhost_remote_in_relp_secure_pre_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
 41: dyn_stats(name="msg_per_fromhost_remote_in_relp_secure_client_auth_pre_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
 42: # To count messages processed at the start of the output ruleset (before output filtering)
 43: dyn_stats(name="msg_per_fromhost" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
 44: 
 45: # Input related rulesets
 46: # Input filter rules are placed in filter/*.conf and should be conditions that drop (stop) messages from being processed futher
 47: 
 48: ruleset(name="remote_in_udp" parser=["rsyslog.rfc5424", "rsyslog.aixforwardedfrom", "custom.rfc3164"]) {
 49:   set $.inc_status = dyn_inc("msg_per_fromhost_remote_in_udp_pre_filter", $fromhost);
 50:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
 51:   if ($.inc_status != 0) then { 
 52:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="DynStatsError")
 53:   }
 54:   set $.syslog-relay!tls = "false";
 55:   set $.syslog-relay!authenticated-client = "false";
 56:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
 57:   $IncludeConfig /etc/rsyslog.d/input/filters/remote_in_udp/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/filters/remote_in_udp/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/filters/remote_in_udp/*.conf
 58:   call central
 59: }
 60: 
 61: ruleset(name="remote_in_tcp" parser=["rsyslog.rfc5424", "rsyslog.aixforwardedfrom", "custom.rfc3164"]) {
 62:   set $.inc_status = dyn_inc("msg_per_fromhost_remote_in_tcp_pre_filter", $fromhost);
 63:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
 64:   if ($.inc_status != 0) then { 
 65:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
 66:   }
 67:   set $.syslog-relay!tls = "false";
 68:   set $.syslog-relay!authenticated-client = "false";
 69:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
 70:   $IncludeConfig /etc/rsyslog.d/input/filters/remote_in_tcp/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/filters/remote_in_tcp/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/filters/remote_in_tcp/*.conf
 71:   call central
 72: }
 73: 
 74: ruleset(name="remote_in_tcp_secure" parser=["rsyslog.rfc5424", "rsyslog.aixforwardedfrom", "custom.rfc3164"]) {
 75:   set $.inc_status = dyn_inc("msg_per_fromhost_remote_in_tcp_secure_pre_filter", $fromhost);
 76:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
 77:   if ($.inc_status != 0) then { 
 78:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
 79:   }
 80:   set $.syslog-relay!tls = "true";
 81:   set $.syslog-relay!authenticated-client = "false";
 82:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
 83:   $IncludeConfig /etc/rsyslog.d/input/filters/remote_in_tcp_secure/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/filters/remote_in_tcp_secure/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/filters/remote_in_tcp_secure/*.conf
 84:   call central
 85: }
 86: 
 87: ruleset(name="remote_in_relp" parser=["rsyslog.rfc5424", "rsyslog.aixforwardedfrom", "custom.rfc3164"]) {
 88:   set $.inc_status = dyn_inc("msg_per_fromhost_remote_in_relp_pre_filter", $fromhost);
 89:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
 90:   if ($.inc_status != 0) then { 
 91:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
 92:   }
 93:   set $.syslog-relay!tls = "false";
 94:   set $.syslog-relay!authenticated-client = "false";
 95:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
 96:   $IncludeConfig /etc/rsyslog.d/input/remote_in_relp/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/remote_in_relp/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/remote_in_relp/*.conf
 97:   call central
 98: }
 99: 
100: # NB: rsyslog limitation seems to block RELP TLS without client authentication
101: ruleset(name="remote_in_relp_secure" parser=["rsyslog.rfc5424", "rsyslog.aixforwardedfrom", "custom.rfc3164"]) {
102:   set $.inc_status = dyn_inc("msg_per_fromhost_remote_in_relp_secure_pre_filter", $fromhost);
103:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
104:   if ($.inc_status != 0) then { 
105:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
106:   }
107:   set $.syslog-relay!tls = "true";
108:   set $.syslog-relay!authenticated-client = "false";
109:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
110:   $IncludeConfig /etc/rsyslog.d/input/remote_in_relp_secure/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/remote_in_relp_secure/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/remote_in_relp_secure/*.conf
111:   call central
112: }
113: 
114: ruleset(name="remote_in_relp_secure_client_auth" parser=["rsyslog.rfc5424", "rsyslog.aixforwardedfrom", "custom.rfc3164"]) {
115:   set $.inc_status = dyn_inc("msg_per_fromhost_remote_in_relp_secure_client_auth_pre_filter", $fromhost);
116:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
117:   if ($.inc_status != 0) then { 
118:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
119:   }
120:   set $.syslog-relay!tls = "true";
121:   set $.syslog-relay!authenticated-client = "true";
122:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/filters/*.conf
123:   $IncludeConfig /etc/rsyslog.d/input/remote_in_relp_secure_client_auth/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/input/remote_in_relp_secure_client_auth/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/input/remote_in_relp_secure_client_auth/*.conf
124:   call central
125: }
126: 
127: # Ouptut rulesets
128: # Rules to output and forward / relay messages placed in output/*.conf and called below
129: 
130: ruleset(
131:   name="central"
132:   # queue config
133:   queue.type="FixedArray"
134:   queue.size="131072"
135:   queue.dequeueBatchSize="2048"
136:   queue.minDequeueBatchSize="256"
137:   queue.minDequeueBatchSize.timeout="500"
138:   queue.workerThreads="8"
139:   queue.workerThreadMinimumMessages="8192"
140: ) {
141: 
142:   set $.inc_status = dyn_inc("msg_per_fromhost", $fromhost);
143:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
144:   if ($.inc_status != 0) then { 
145:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
146:   }
147: 
148:   # Add metadata about how the message was received and compensate for malformed messages
149:   # TODO: Copy and create properties in a nested metadata json subelement called "syslog-relay"
150:   # Note:
151:   # - Copying properties is less efficient.
152:   # - But this could simplify manually constructing JSON output with complex templates...
153:   # - `$!` can be output without needing to know exactly which JSON fields are present or not allowing more dynamic attributes for messages.
154:   # There are issues formatting nested JSON output and items commented out due to limitations:
155:   # - Instead, explicit / manual templating for JSON is the current workaround.
156:   # - See https://github.com/rsyslog/rsyslog/issues/2873
157:   # - See https://github.com/rsyslog/rsyslog/issues/2827
158:   # Commented out due to above limitations
159:   #set $.syslog-relay!timegenerated = format_time($timegenerated, "date-rfc3339");
160:   #set $.syslog-relay!fromhost = $fromhost;
161:   #set $.syslog-relay!fromhost-ip = $fromhost-ip;
162:   #set $.syslog-relay!myhostname = $$myhostname;
163:   #set $.syslog-relay!inputname = $inputname;
164:   if ($protocol-version == "1") then {
165:     # When rsyslog parses a message as version 1 / RFC5424, it implies parsing worked, but sometimes not all fields can be parsed.
166:     set $.syslog-relay!pri-valid = "true";
167:     # Detect malformed RFC5424 messages with bad timestamps which cause the 'programname' to be set as an empty string.
168:     # E.g. '<14>1 2017-09-21 23:43:29 behave test 99999 - incorrect non-IS08601 timestamp with extra space'
169:     if ($programname == "") then {
170:       set $.syslog-relay!format = "RFC5424_malformed";
171:       set $.syslog-relay!header-valid = "false";
172:     } else {
173:       set $.syslog-relay!format = "RFC5424";
174:       set $.syslog-relay!header-valid = "true";
175:     }
176:     # If rsyslog can't parse the timestamp or hostname for RFC5424, it seems to populate $hostname automatically from $fromhost
177:     set $.hostname = $hostname;
178:   } else if ($app-name == "rsyslogd-pstats" and ($fromhost-ip == "127.0.0.1" or $fromhost-ip == "::1" )) then {
179:       # Catch corner case where rsyslog impstats produces valid header properties, but the rawmsg field doesn't include the standard syslog header because it's internal
180:       set $.syslog-relay!format = "NA_internal_rsyslogd-pstats";
181:       set $.syslog-relay!pri-valid = "false";
182:       set $.syslog-relay!header-valid = "false";
183:       set $.hostname = $hostname;
184:   } else {
185:     # assume protocol-version == 0
186:     # check priority
187:     # 0-191 are valid priority encodings, set to 192 > 191 to indicate invalid
188:     set $.pri-test = cnum(re_extract($rawmsg, "^<([0-9]{1,3})>", 0, 0, "192"));
189:     if ($.pri-test > 191) then {
190:       set $.syslog-relay!format = "RFC3164_malformed";
191:       set $.syslog-relay!pri-valid = "false";
192:       set $.hostname = $fromhost;
193:     } else {
194:       set $.syslog-relay!pri-valid = "true";
195:     }
196:     # Check syslog header (date and hostname)
197:     # - See https://github.com/rsyslog/rsyslog/issues/1789
198:     # - Regex is costly, so skim for 'Mmm' pattern of date (but dont match to actual months)
199:     # - Also use a trick to see if rsyslog assumed the first word was the hostname after failing to parse a syslog header date
200:     if (not re_match($rawmsg-after-pri, "^[A-Z][a-z]{2}") or $rawmsg-after-pri startswith $hostname) then {
201:       # rsyslog assumed first word of malformed message was the hostname, so RFC3164 conventions for timestamp and hostname not followed
202:       set $.syslog-relay!format = "RFC3164_malformed";
203:       set $.syslog-relay!header-valid = "false";
204:       set $.hostname = $fromhost;
205:       # If we wanted to correct a misaligned $msg due to a bad header...
206:       #set $.msg = $rawmsg-after-pri;
207:     } else {
208:       set $.syslog-relay!format = "RFC3164";
209:       # above checks not 100% precise to avoid perfomance cost, so only reasonably confident a good header was found
210:       set $.syslog-relay!header-valid = "true";
211:       set $.hostname = $hostname;
212:       #set $.msg = $msg;
213:     }
214:     # TODO check for valid app-name and processs ID values?
215:   }
216: 
217:   # Parse RFC5424 structured elements into JSON
218:   if ($structured-data == "-") then {
219:     # !rfc5424-sd won't be created if there's no structured data, but a template might expect it to exist. See https://github.com/rsyslog/rsyslog/issues/1891
220:     # Note rsyslog json properties don't yet support setting a proper JSON null value, so use a string
221:     set $!rfc5424-sd = "null";
222:   } else {
223:     # jsonRoot doesn't change the name of where fields are parsed to. It just moves where it is put. See https://github.com/rsyslog/rsyslog/issues/1262
224:     #action(type="mmpstrucdata" name="output_mmpstrucdata" jsonRoot="$!structured-data")
225:     action(type="mmpstrucdata" name="output_mmpstrucdata")
226:     # Guard against $!rfc5424-sd not existing if there was a parse failure
227:     # Note, rsyslog has not yet got an exits() function, so workaround is to check for a blank string: https://github.com/rsyslog/rsyslog/issues/970
228:     if ($!rfc5424-sd == "") then {
229:       set $!rfc5424-sd = "null";
230:       set $.syslog-relay!format = "RFC5424_malformed";
231:     }
232:   }
233: 
234:   # Support trying to decode msg part as JSON (hopefully fails fast when not JSON)
235:   # - nullify $!msg-json if there is a failure
236:   # - null is represented as the literal string "null" and requires care with templates to output as a true JSON null datatype
237:   # By default, require the @cee cookie
238:   action(type="mmjsonparse" name="mmjsonparse_cee")
239:   if $parsesuccess == "OK" then {
240:     set $.syslog-relay!json-msg-parsed = "true";
241:     continue
242:   } else {
243:     # Also try parsing message as JSON without the @cee cookie
244:     # - mmjsonparse will fail to decode messages that have both structured data elements and JSON without a @cee cookie
245:     action(type="mmjsonparse" name="mmjsonparse_without_cee" cookie="")
246:     if $parsesuccess == "OK" then {
247:       set $.syslog-relay!json-msg-parsed = "true";
248:     } else {
249:       # remove duplicated $!msg field (will use $msg in templates instead)
250:       unset $!msg;
251:       set $.syslog-relay!json-msg-parsed = "false";
252:     }
253:   }
254: 
255:   # global output filter
256:   $IncludeConfig /etc/rsyslog.d/output/filters/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/output/filters/*.conf
##^ expanding file: /etc/rsyslog.d/output/filters/exclude_debug.conf
  1: # don't permit debug level logging
  2: if ( $syslogseverity == '7' ) then { stop }
##^ expanding file: /etc/rsyslog.d/output/filters/include_all.conf
  1: # tests white-list approach where this regex matches everything
  2: if (not re_match($msg, ".*")) then { stop }
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/output/filters/*.conf
257: 
258:   # Standard outputs "pre-bundled
259:   call out_file
260:   call fwd_kafka
261:   call fwd_syslog
262:   call fwd_json
263: 
264:   # Add extra output ruleset call for extra conf
265:   call fwd_extra
266: 
267: }
##> end of expand directive: $IncludeConfig /etc/rsyslog.d/*.conf
 13: $IncludeConfig /etc/rsyslog.d/input/*.conf
##< start of include directive: $IncludeConfig /etc/rsyslog.d/input/*.conf
##^ expanding file: /etc/rsyslog.d/input/41-udp_in.conf
  1: module(
  2:   load="imudp"
  3:   BatchSize="128"
  4:   threads="2"
  5:   SchedulingPolicy="fifo"
  6:   SchedulingPriority="10"
  7: )
  8: 
  9: # provides UDP syslog resception
 10: input(
 11:   type="imudp"
 12:   port="514"
 13:   RcvBufSize="0"
 14:   RateLimit.Interval="0"
 15:   RateLimit.Burst="262144"
 16:   ruleset="remote_in_udp"
 17: )
##^ expanding file: /etc/rsyslog.d/input/42-tcp_in.conf
  1: # Note:
  2: # - RSyslog TCP relies on a stream driver, and the stream driver settings are global because they are set when the module is imtcp module is loaded.
  3: # - Therefore, there cannot be varied TLS security requirements for multiple TCP TLS inputs.
  4: # - There don't seem to be any documented settings for TLS client auth as optional (it's either required or not).
  5: 
  6: # Global directives related to TCP
  7: global(
  8:   # TCP TLS (does not apply to RELP)
  9:   defaultNetstreamDriverCAFile="/usr/local/etc/pki/test/test_ca.cert.pem"
 10:   defaultNetstreamDriverCertFile="/usr/local/etc/pki/test/test_syslog_server.cert.pem"
 11:   defaultNetstreamDriverKeyFile="/usr/local/etc/pki/test/test_syslog_server.key.pem"
 12:   defaultNetstreamDriver="ptcp"
 13: )
 14: 
 15: # For plain TCP without TLS (tailored for high performance on Linux)
 16: module(
 17:   load="imptcp"
 18:   threads="4"
 19:   processOnPoller="off"
 20: )
 21: # For TCP with TLS (imptcp does not support TLS)
 22: module(
 23:   load="imtcp"
 24:   maxSessions="1000"
 25:   KeepAlive="off"
 26:   flowControl="on"
 27:   NotifyOnConnectionClose="off"
 28:   streamDriver.name="gtls"
 29:   #streamDriver.name="ossl"
 30:   streamDriver.mode="1"
 31:     #This indicates TLS is enabled. 0 indicated disabled.
 32:   streamDriver.authMode="anon"
 33:   
 34: )
 35: 
 36: # provides plain TCP syslog reception. Both port 514 and 601 (IANA offical registered number)
 37: input(
 38:   type="imptcp"
 39:   port="514"
 40:   ruleset="remote_in_tcp"
 41:   SocketBacklog="128"
 42:   KeepAlive="off"
 43:   flowControl="on"
 44:   NotifyOnConnectionOpen="off"
 45:   NotifyOnConnectionClose="off"
 46:   RateLimit.Interval="0"
 47:   RateLimit.Burst="262144"
 48: )
 49: input(
 50:   type="imptcp"
 51:   port="601"
 52:   ruleset="remote_in_tcp"
 53:   SocketBacklog="128"
 54:   KeepAlive="off"
 55:   flowControl="on"
 56:   NotifyOnConnectionOpen="off"
 57:   NotifyOnConnectionClose="off"
 58:   RateLimit.Interval="0"
 59:   RateLimit.Burst="262144"
 60: )
 61: 
 62: # provides secure TCP syslog reception
 63: input(
 64:   type="imtcp"
 65:   name="tcp_secure"
 66:   port="6514"
 67:   RateLimit.Interval="0"
 68:   RateLimit.Burst="262144"
 69:   ruleset="remote_in_tcp_secure"
 70: )
##^ expanding file: /etc/rsyslog.d/input/43-relp_in.conf
  1: # RELP and librelp seems to support it's own TLS settings per input. Therefore, there can be varied TLS security requirements (e.g. needing client auth) per RELP input and port.
  2: 
  3: module(
  4:   load="imrelp"
  5:   #tls.tlslib="openssl"
  6: )
  7: 
  8: # proivdes RELP reception without TLS
  9: input(
 10:   type="imrelp"
 11:   name="imrepl"
 12:   port="2514"
 13:   ruleset="remote_in_relp"
 14:   KeepAlive="off"
 15:   tls="off"
 16: )
 17: 
 18: # provides secure RELP reception (with client not needing to provide a CA signed cert)
 19: # Limitation:
 20: # - even if tls.authMode is not set, RELP GnuTLS implimentation seems to default requesting a client certifcate
 21: # - might be fixed in future: https://github.com/rsyslog/rsyslog/issues/435
 22: input(
 23:   type="imrelp"
 24:   name="imrelp_secure"
 25:   port="7514"
 26:   ruleset="remote_in_relp_secure"
 27:   KeepAlive="off"
 28:   tls="on"
 29:   tls.dhbits="2048"
 30:   tls.caCert="/usr/local/etc/pki/test/test_ca.cert.pem"
 31:   tls.myCert="/usr/local/etc/pki/test/test_syslog_server.cert.pem"
 32:   tls.myPrivKey="/usr/local/etc/pki/test/test_syslog_server.key.pem"
 33:   #tls.authMode="anon"
 34: )
 35: 
 36: # provides secure RELP reception (with client needing to provide a CA signed cert)
 37: input(
 38:   type="imrelp"
 39:   name="imrelp_secure_client_auth"
 40:   port="8514"
 41:   ruleset="remote_in_relp_secure_client_auth"
 42:   KeepAlive="off"
 43:   tls="on"
 44:   tls.dhbits="2048"
 45:   tls.caCert="/usr/local/etc/pki/test/test_ca.cert.pem"
 46:   tls.myCert="/usr/local/etc/pki/test/test_syslog_server.cert.pem"
 47:   tls.myPrivKey="/usr/local/etc/pki/test/test_syslog_server.key.pem"
 48:   tls.authMode="certvalid"
 49:   
 50:   tls.permittedPeer=["*"]
 51:   
 52: )
##> end of expand directive: $IncludeConfig /etc/rsyslog.d/input/*.conf
 14: $IncludeConfig /etc/rsyslog.d/output/*.conf
##< start of include directive: $IncludeConfig /etc/rsyslog.d/output/*.conf
##^ expanding file: /etc/rsyslog.d/output/71-out_file.conf
  1: ## Option to write remote logs to plain files
  2: # Note further, it would be prudent to setup logrotate for /var/log/remote/*
  3: # See 50-ruleset.conf for the parent ruleset that calls this
  4: # This will be blank if rsyslog_omfile_enabled="on" is not set
  5: 
  6: # Avoid using invalid hostnames if possible (meta-data enabled)
  7: template(name="TmplPerHostFile" type="string" string="/var/log/remote/%$.hostname%")
  8: 
  9: 
 10: # Dynamic stats for output
 11: dyn_stats(name="msg_per_fromhost_out_file_post_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
 12: 
 13: ruleset(name="out_file") {
 14: 
 15:   $IncludeConfig /etc/rsyslog.d/output/filters/out_file/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/output/filters/out_file/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/output/filters/out_file/*.conf
 16: 
 17:   set $.inc_status = dyn_inc("msg_per_fromhost_out_file_post_filter", $fromhost);
 18:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
 19:   if ($.inc_status != 0) then { 
 20:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
 21:   }
 22: 
 23:   # In the simple case, we use the hostname as the filename and place all logs in that file
 24:   action(
 25:        name="out_file_remote_in_file_hostname"
 26:        type="omfile"
 27:        template="TmplRSyslogJSON"
 28:        dynaFile="TmplPerHostFile"
 29:        dynaFileCacheSize="100"
 30:        asyncWriting="on"
 31:        flushOnTXEnd="off"
 32:        ioBufferSize="256k"
 33:        dirOwner="root"
 34:        dirGroup="wheel"
 35:        dirCreateMode="0755"
 36:        fileOwner="root"
 37:        fileGroup="wheel"
 38:        FileCreateMode="0640"
 39:   )
 40: 
 41:   
 42: }##^ expanding file: /etc/rsyslog.d/output/81-fwd_kafka.conf
  1: # Kafka output (if enabled, else blank)
  2: module(load="omkafka")
  3: 
  4: # Dynamic stats for output
  5: dyn_stats(name="msg_per_fromhost_fwd_kafka_post_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
  6: 
  7: ruleset(name="fwd_kafka")
  8: {
  9:   $IncludeConfig /etc/rsyslog.d/output/filters/fwd_kafka/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/output/filters/fwd_kafka/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/output/filters/fwd_kafka/*.conf
 10: 
 11:   set $.inc_status = dyn_inc("msg_per_fromhost_fwd_kafka_post_filter", $fromhost);
 12:   # TODO - improve action when increment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
 13:   if ($.inc_status != 0) then {
 14:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
 15:   }
 16: 
 17:   action(
 18:     name="fwd_kafka_topic_test_syslog"
 19:     type="omkafka"
 20:     broker=["test_kafka:9092"]
 21:     confParam=["batch.num.messages=1", "queue.buffering.max.ms=100", "sasl.mechanisms=PLAIN", "sasl.username=test", "sasl.password=test-secret", "security.protocol=sasl_ssl", "ssl.ca.location=/usr/local/etc/pki/test/test_ca.cert.pem", "ssl.key.location=/usr/local/etc/pki/test/test_syslog_server.key.pem", "ssl.certificate.location=/usr/local/etc/pki/test/test_syslog_server.cert.pem"]
 22:     topic="test_syslog"
 23:     dynatopic="off"
 24:     partitions.auto="on"
 25:     
 26:     resubmitOnFailure="on"
 27:     keepFailedMessages="on"
 28:     failedMsgFile="/var/lib/rsyslog/kafka_failed.msg"
 29:     template="TmplJSON"
 30:     action.resumeRetryCount = "-1"
 31:     # queue config
 32:     queue.type="LinkedList"
 33:     queue.filename="fwd_kafka"
 34:     # queue peristance and size limit
 35:     queue.maxDiskSpace="1073741824"
 36:     queue.size="1048576"
 37:     queue.discardMark="838860"
 38:     queue.discardSeverity="6"
 39:     queue.checkpointInterval="8192"
 40:     queue.saveOnShutdown="on"
 41:     # queue threads and batching
 42:     queue.dequeueBatchSize="1024"
 43:     queue.minDequeueBatchSize="128"
 44:     queue.minDequeueBatchSize.timeout="500"
 45:     queue.workerThreads="4"
 46:     queue.workerThreadMinimumMessages="8192"
 47:   )
 48: }
##^ expanding file: /etc/rsyslog.d/output/82-fwd_syslog.conf
  1: # Syslog output (if enabled, else blank)
  2: # omfwd module is loaded by deafault / built-in
  3: 
  4: # Dynamic stats for output
  5: dyn_stats(name="msg_per_fromhost_fwd_syslog_post_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
  6: 
  7: ruleset(name="fwd_syslog")
  8: {
  9:   $IncludeConfig /etc/rsyslog.d/output/filters/fwd_syslog/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/output/filters/fwd_syslog/*.conf
##^ expanding file: /etc/rsyslog.d/output/filters/fwd_syslog/exclude_foobar.conf
  1: # tests black-list approach
  2: if $msg contains "foobar" then { stop }
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/output/filters/fwd_syslog/*.conf
 10: 
 11:   set $.inc_status = dyn_inc("msg_per_fromhost_fwd_syslog_post_filter", $fromhost);
 12:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
 13:   if ($.inc_status != 0) then {
 14:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
 15:   }
 16: 
 17:   action(
 18:     name="fwd_syslog_target_test_syslog_relay"
 19:     type="omfwd"
 20:     Target="test_syslog_relay"
 21:     Port="10514"
 22:     Protocol="tcp"
 23:     template="TmplRFC5424Meta"
 24:     action.resumeRetryCount = "-1"
 25:     # queue config 
 26:     queue.type="LinkedList"
 27:     queue.filename="fwd_syslog"
 28:     # queue peristance and size limit
 29:     queue.maxDiskSpace="1073741824"
 30:     queue.size="1048576"
 31:     queue.discardMark="838860"
 32:     queue.discardSeverity="6"
 33:     queue.checkpointInterval="8192"
 34:     queue.saveOnShutdown="on"
 35:     # queue threads and batching
 36:     queue.dequeueBatchSize="1024"
 37:     queue.minDequeueBatchSize="128"
 38:     queue.minDequeueBatchSize.timeout="500"
 39:     queue.workerThreads="4"
 40:     queue.workerThreadMinimumMessages="8192"
 41:   )
 42: }
##^ expanding file: /etc/rsyslog.d/output/83-fwd_json.conf
  1: # JSON output (if enabled, else blank)
  2: # omfwd module is loaded by deafault / built-in
  3: 
  4: # Dynamic stats for output
  5: dyn_stats(name="msg_per_fromhost_fwd_json_post_filter" resettable="on" maxCardinality="10000" unusedMetricLife="86400" )
  6: 
  7: ruleset(name="fwd_json")
  8: {
  9:   $IncludeConfig /etc/rsyslog.d/output/filters/fwd_json/*.conf
##< start of include directive:   $IncludeConfig /etc/rsyslog.d/output/filters/fwd_json/*.conf
##> end of expand directive:   $IncludeConfig /etc/rsyslog.d/output/filters/fwd_json/*.conf
 10: 
 11:   set $.inc_status = dyn_inc("msg_per_fromhost_fwd_json_post_filter", $fromhost);
 12:   # TODO - improve action when incriment failed, e.g. cumbersome but would show up in impstats action counts at least to know there is an issue
 13:   if ($.inc_status != 0) then {
 14:     action(name="dyn_stat_inc_error" type="omfile" file="/dev/null" template="Empty")
 15:   }
 16: 
 17:   action(
 18:     name="fwd_json_target_test_json_relay"
 19:     type="omfwd"
 20:     Target="test_json_relay"
 21:     Port="15000"
 22:     Protocol="tcp"
 23:     template="TmplJSONRawMsg"
 24:     action.resumeRetryCount = "-1"
 25:     # often last message is lost when a connection breaks
 26:     resendLastMSGOnReconnect="on"
 27:     # queue config
 28:     queue.type = "LinkedList"
 29:     queue.filename="fwd_json"
 30:     # queue peristance and size limit
 31:     queue.maxDiskSpace="1073741824"
 32:     queue.size="1048576"
 33:     queue.discardMark="838860"
 34:     queue.discardSeverity="6"
 35:     queue.checkpointInterval="8192"
 36:     queue.saveOnShutdown="on"
 37:     # queue threads and batching
 38:     queue.dequeueBatchSize="1024"
 39:     queue.minDequeueBatchSize="128"
 40:     queue.minDequeueBatchSize.timeout="500"
 41:     queue.workerThreads="4"
 42:     queue.workerThreadMinimumMessages="8192"
 43:   )
 44: }
##> end of expand directive: $IncludeConfig /etc/rsyslog.d/output/*.conf
 15: 
 16: # Optional extra custom config to inlcude from volume via /etc/rsyslog.d/extra
 17: $IncludeConfig /etc/rsyslog.d/extra/*.conf
##< start of include directive: $IncludeConfig /etc/rsyslog.d/extra/*.conf
##^ expanding file: /etc/rsyslog.d/extra/91_extra_test.conf
  1: # Example config for own custom input and outputs either independent or integrated with other pre-existing inputs or outputs.
  2: 
  3: module(load="imkafka")
  4: 
  5: # Independent input
  6: # - Doesn't integrate with other existing outputs in /etc/rsyslog.d/output
  7: # - Not affected by any other input filters
  8: input(
  9:   type="imkafka"
 10:   topic="extra_syslog"
 11:   broker=["test_kafka:9092"]
 12:   ConfParam=["batch.num.messages=1", "queue.buffering.max.ms=100", "client.id=rsyslog_extra", "sasl.mechanisms=PLAIN", "sasl.username=test", "sasl.password=test-secret", "security.protocol=sasl_ssl", "ssl.ca.location=/usr/local/etc/pki/test/test_ca.cert.pem", "ssl.key.location=/usr/local/etc/pki/test/test_syslog_server.key.pem", "ssl.certificate.location=/usr/local/etc/pki/test/test_syslog_server.cert.pem"]
 13:   consumergroup="rsyslog_extra"
 14:   ruleset="extra_kafka_input"
 15: )
 16: 
 17: # Independent output
 18: # - Doesn't integrate with other existing inputs in /etc/rsyslog.d/input, except the above input that calls it.
 19: # - Not affected by any other output filters
 20: # - But does depend on a template already defined in 60-output_format.conf
 21: ruleset(name="extra_kafka_input" parser="rsyslog.pmnull") {
 22:   action(
 23:     type="omfile"
 24:     template="RawMsg"
 25:     file="/var/log/remote/extra_kafka_input.log"
 26:   )
 27: }
 28: 
 29: # Integrated extra output
 30: # - rsyslog_call_fwd_extra_rule=true must be set
 31: # - Then /etc/rsyslog.d/60-output_format.conf should call this ruleset after the other pre-defined outputs
 32: # - Expects the ruleset with name `fwd_extra` to be defined in a file in /etc/rsyslog.d/extra/ and rsyslog will fail to start if it is missing
 33: # - Will be affected by global output filters in /etc/rsyslog.d/output/filters/*
 34: # - Input filters will also apply
 35: ruleset(name="fwd_extra") {
 36:   action(
 37:     type="omfile"
 38:     template="RawMsg"
 39:     file="/var/log/remote/all_raw.log"
 40:   )
 41: }
 42: 
 43: # Integrated extra input
 44: # - To plug input into pre-defined outputs of /etc/rsyslog.d/output/, must set ruleset="central"
 45: # - Then, global input filters from /etc/rsyslog.d/input/filters/* will apply
 46: # - And, global output filters from /etc/rsyslog.d/output/filters/* will apply
 47: module(load="imfile")
 48: input(
 49:   type="imfile"
 50:   File="/tmp/test_imfile"
 51:   PersistStateInterval="60"
 52:   freshStartTail="on"
 53:   Tag="test_imfile:"
 54:   Severity="info"
 55:   Facility="local7"
 56:   ruleset="central"
 57: )
##> end of expand directive: $IncludeConfig /etc/rsyslog.d/extra/*.conf
